<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>YiGuo添加商品</title>
  <link rel="stylesheet" href="../layui/css/layui.css">
  <script type="text/javascript" src="../layui/layui.js"></script>
  <script type="text/javascript" src="../layui/lay/modules/upload.js"></script>
  <script type="text/javascript" src="../js/common.js"></script>
  <script type="text/javascript" src="../js/jquery-1.10.1.min.js"></script>
  <script type="text/javascript" src="../js/public.js"></script>
  <style type="text/css">
    .add_categroy{
      display: block !important;
    }
  </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
  <div class="layui-header">
    <div class="layui-logo">YiGuo后台管理</div>
    <!-- 头部区域（可配合layui已有的水平导航） -->
    <ul class="layui-nav layui-layout-left">
      <li class="layui-nav-item"><a href="">控制台</a></li>
      <li class="layui-nav-item"><a href="">商品管理</a></li>
      <li class="layui-nav-item"><a href="">用户</a></li>
      <li class="layui-nav-item">
        <a href="javascript:;">其它系统</a>
        <dl class="layui-nav-child">
          <dd><a href="">邮件管理</a></dd>
          <dd><a href="">消息管理</a></dd>
          <dd><a href="">授权管理</a></dd>
        </dl>
      </li>
    </ul>
    <ul class="layui-nav layui-layout-right">
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon" style='padding-right: 10px;'>&#xe770;</i>
          <span>贤心</span>
        </a>
        <dl class="layui-nav-child">
          <dd><a href="">基本资料</a></dd>
          <dd><a href="">安全设置</a></dd>
        </dl>
      </li>
      <li class="layui-nav-item outName"><a href="">退了</a></li>
    </ul>
  </div>
  
  <div class="layui-side layui-bg-black">
    <div class="layui-side-scroll">
      <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
      <ul class="layui-nav layui-nav-tree"  lay-filter="test">
        <li class="layui-nav-item layui-nav-itemed">
          <a class="" href="javascript:;">商品管理</a>
          <dl class="layui-nav-child">
            <dd><a href="goodsList.html">商品列表</a></dd>
            <dd><a href="goodsCategory.html">商品分类</a></dd>
            <dd><a href="addGoods.html">添加商品</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a href="javascript:;">用户管理</a>
          <dl class="layui-nav-child">
            <dd><a href="userList.html">用户列表</a></dd>
            <dd><a href="addUsers.html">添加用户</a></dd>
          </dl>
        </li>
         <li class="layui-nav-item">
          <a href="javascript:;">订单管理</a>
          <dl class="layui-nav-child">
            <dd><a href="orderList.html">订单列表</a></dd>
          </dl>
        </li>
       <!--  <li class="layui-nav-item"><a href="">云市场</a></li>
        <li class="layui-nav-item"><a href="">发布商品</a></li> -->
      </ul>
    </div>
  </div>
  
  <div class="layui-body">
    <!-- 内容主体区域 -->
    <div style="padding: 30px 0 0 20px;">
        <div class="layui-form">
        <!-- 商品名称开始 -->
          <div class="layui-form-item" style="width:410px">
            <label class="layui-form-label">商品名称</label>
            <div class="layui-input-block">
              <input type="text" name="title" required  lay-verify="required" placeholder="请输入标题" autocomplete="off" class="layui-input name">
            </div>
        </div>
        <!-- 商品名称结束 -->
        <!-- 商品分类开始 -->
         
           <div class="layui-form-item">
                    <label class="layui-form-label">商品分类：</label>
                    <div class="layui-input-inline">
                        <select name="modules" lay-verify="required" lay-search="" style="height:36px;width:300px;padding-left:10px;border-radius:2px;border-color:#e6e6e6;"  class="add_categroy">
                            <!-- <option value="">选择商品分类</option>
                            <option value="1">苹果</option>
                            <option value="2">梨</option>
                            <option value="3">桃</option>
                            <option value="4">橘</option>
                            <option value="5">橙</option>
                            <option value="6">柚</option>
                            <option value="7">葡萄</option>
                            <option value="8">香蕉</option>
                            <option value="9">柿子</option> -->
                            
                        </select>
                    </div>
                </div>
        <!-- 商品分类结束-->
        <!-- 商品价格开始 -->
        <div class="layui-form-item">
 
          <div class="layui-inline">
            <label class="layui-form-label">原价</label>
            <div class="layui-input-inline" style="width: 100px;">
              <input type="text" name="price_min" placeholder="￥" autocomplete="off" class="layui-input before_price">
            </div>
            <div class="layui-form-mid" style='margin-left: 20px;'>现价</div>
            <div class="layui-input-inline" style="width: 100px;">
              <input type="text" name="price_max" placeholder="￥" autocomplete="off" class="layui-input now_price">
            </div>
          </div>
        </div>
        <!-- 商品价格开始 -->
        <!-- 商品库存开始 -->
        <div class="layui-form-item">
          <label class="layui-form-label ">商品库存</label>
          <div class="layui-input-inline">
            <input type="text" name="password" required lay-verify="required" placeholder="请输入商品库存" autocomplete="off" class="layui-input stock">
        </div>
         </div>
        <!-- 商品库存结束 -->
        
          <div class="layui-form-item">
            <label class="layui-form-label">上架</label>
            <div class="layui-input-block">
              <input type="checkbox" name="switch" lay-skin="switch">
            </div>
          </div>
           <!-- 商品图片开始 -->
          <div class="layui-upload" style='padding-left: 30px;'>
                    <button type="file" class="layui-btn layui-btn-warm" id="test2">多图片上传</button> 
                    <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                    预览图：（注：第一张为封面）
                        <div class="layui-upload-list" id="demo2">
                        </div>
                    </blockquote>
                </div>
              
                <!-- <input type="file" multiple id="goods" /> -->
         <!-- 商品图片结束 -->
         <!-- 商品介绍开始 -->
          <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">商品介绍</label>
            <div class="layui-input-block">
              <textarea name="desc" placeholder="请输入内容" class="layui-textarea introduce"></textarea>
            </div>
          </div>
         <!-- 商品介绍结束 -->
        
        

          <div class="layui-form-item">
            <div class="layui-input-block">
              <button class="layui-btn" lay-submit lay-filter="formDemo" id="addBtn">增加商品</button>
              <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
          </div>
        </div>
    </div>
  </div>
  
  <div class="layui-footer">
    <!-- 底部固定区域 -->
    © layui.com - 底部固定区域
  </div>
</div>
<script>
//JavaScript代码区域
layui.use('element', function(){
  var element = layui.element;
  
});



</script>
<script type="text/javascript">
    //用户名渲染
  // let users = localStorage.getItem('users');
  // console.log(JSON.parse(users).name);
  // let _name=JSON.parse(users).name;
  // showUsername(_name);
  // //用户退出
  // outUsername(_name);

  // ======================================
  // 通过cookie设置头部的用户名显示
  // var cookie=cookie.get('user');
  // showUsername(cookie);
  //================================================================
  $(function(){
    //增加商品(做商品分类，等商品分类渲染出来才做)
    findAll();
    //=========================
    var addpict=[];
    //====================================
    layui.use('upload', function(){
           var arr=[];
            var $ = layui.jquery
            ,upload = layui.upload;

            //多图片上传
            upload.render({
                elem: '#test2'
                ,url: '/goods/upload'
                ,multiple: true
                ,auto: true
                ,before: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                    $('#demo2').append('<img src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img add_img" style="width:92px;height:92px;margin:0 10px 10px 0">')
                    });
                }
                ,done: function(res){
                    // console.log(res);
                    // var arr=[];
                    arr.push(res.imagename);
                    
                    // console.log(res.imagename);
                    // str+=res.imagename;
                    // console.log($('.add_img').length);
                    if(arr.length==$('.add_img').length){
                       console.log(11);
                       //=========================================
                       $('#addBtn').on('click',function(){
                        var name=$('.name').val();
                        var category=$('select').val();
                        var before_price=$('.before_price').val();
                        var now_price=$('.now_price').val();
                        var add_img = $('.add_img');
                        var stock=$('.stock').val();
                        var introduce=$('.introduce').val();
                        for(var j=0;j<add_img.length;j++){
                            var Arr=$('#demo2').find('img').eq(j).attr('alt')
                            addpict.push(Arr);
                        }
                        console.log(addpict);
                        var img1=arr[0];
                        data={name:name,category:category,before_price:before_price,now_price:now_price,stock:stock,introduce:introduce,img1:img1};
                        if(name&&category&&before_price&&now_price&&stock&&introduce){
                          add(data);

                          //添加成功后,清空表单数据
                          $('.name').val('');
                          $('select').val('');
                          $('.before_price').val('');
                          $('.now_price').val('');
                          $('.stock').val('');
                          $('.introduce').val('');
                        }else{
                          alert('信息不完整');
                        }
                      });
                    }
                }
            });
        });
    
  });

  function findAll(){
     $.ajax({
        type:'get',
        url:'/category/_findAll',
        data:{},
        async:true,
        success:function(str){
            // fn(str);
            var res='<option value="">选择商品分类</option>';
            res+=str.map(function(item,idx){
              return `<option value="${item.category}">${item.category}</option>`;
            }).join('');
            
            $('.add_categroy').html(res);
        }
     });    
  }
 
  //3.增加数据（增加后渲染页面）
  //参数：data:商品分类的值,是一个对象,格式data={name:xiao,age:18}
  //      fun2:渲染数据结构的函数，在这里，所有渲染数据结构的函数名都是show
  //      url:查询所有数据的路由
   function add(data){

         // ajax请求
         $.ajax({
            type:'get',
            url:'/goods/_add',
            data:data,
            async:true,
            // processData:false,
            success:function(str){
                // console.log(str);
                // var res=JSON.parse(str);
                // if(str.n=='1'){
                //   //渲染页面
                //   // findAll();
                // }else{
                //   alert('增加失败');
                // }
            }
         });   
         // //发送ajax请求
         //      let xhr=new XMLHttpRequest();
         //      xhr.open('post','/goods/_add',true);
         //      xhr.send(data);
        
  }
  //点击Logo跳转到首页
  index();
  //Demo
      // layui.use('form', function(){
      //     var form = layui.form;
      //     //监听提交
      //     form.on('submit(formDemo)', function(data){
      //       layer.msg(JSON.stringify(data.field));
            
      //       return false;
      //     });
      // });
      //=============================================
        //=========================================
// 通过cookie设置头部的用户名显示,如果不是登录状态，都跳转到登陆页面
login();
</script>
</body>
</html>