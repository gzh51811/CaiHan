<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>YiGuo商品分类</title>
  <link rel="stylesheet" href="../layui/css/layui.css">
  <link rel="stylesheet" href="../css/shade.css">
  <script type="text/javascript" src="../layui/layui.js"></script>
  <script type="text/javascript" src="../js/common.js"></script>
  <script type="text/javascript" src="../js/jquery-1.10.1.min.js"></script>
  <script type="text/javascript" src="../js/public.js"></script>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
  <div class="layui-header">
    <div class="layui-logo">YiGuo后台管理</div>
    <!-- 头部区域（可配合layui已有的水平导航） -->
    <ul class="layui-nav layui-layout-left">
      <li class="layui-nav-item"><a href="">控制台</a></li>
      <li class="layui-nav-item"><a href="">商品管理</a></li>
      <li class="layui-nav-item"><a href="">用户</a></li>
      <li class="layui-nav-item">
        <a href="javascript:;">其它系统</a>
        <dl class="layui-nav-child">
          <dd><a href="">邮件管理</a></dd>
          <dd><a href="">消息管理</a></dd>
          <dd><a href="">授权管理</a></dd>
        </dl>
      </li>
    </ul>
    <ul class="layui-nav layui-layout-right">
      <li class="layui-nav-item">
        <a href="javascript:;">
          <i class="layui-icon" style='padding-right: 10px;'>&#xe770;</i>
          <span>贤心</span>
        </a>
        <dl class="layui-nav-child">
          <dd><a href="">基本资料</a></dd>
          <dd><a href="">安全设置</a></dd>
        </dl>
      </li>
      <li class="layui-nav-item outName"><a href="">退了</a></li>
    </ul>
  </div>
  
  <div class="layui-side layui-bg-black" >
    <div class="layui-side-scroll">
      <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
      <ul class="layui-nav layui-nav-tree"  lay-filter="test">
        <li class="layui-nav-item layui-nav-itemed">
          <a class="" href="javascript:;">商品管理</a>
          <dl class="layui-nav-child">
            <dd><a href="goodsList.html">商品列表</a></dd>
            <dd><a href="goodsCategory.html">商品分类</a></dd>
            <dd><a href="addGoods.html">添加商品</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a href="javascript:;">用户管理</a>
          <dl class="layui-nav-child">
            <dd><a href="userList.html">用户列表</a></dd>
            <dd><a href="addUsers.html">添加用户</a></dd>
          </dl>
        </li>
         <li class="layui-nav-item">
          <a href="javascript:;">订单管理</a>
          <dl class="layui-nav-child">
            <dd><a href="orderList.html">订单列表</a></dd>
          </dl>
        </li>
       
      </ul>
    </div>
  </div>
  
    <div class="layui-body">
    <!-- 内容主体区域开始 -->
       <div style="padding: 30px 0 0 50px">
            <button class="layui-btn addBtn">
                        <i class="layui-icon">&#xe608;</i> 添加
                      </button>
            <table class="layui-table" style='width:650px;z-index: -11;'>
             
              <thead>
                <tr>
                  <th style='text-align: center;width:150px'>序号</th>
                  <th style='text-align: center;width:100px'>分类名</th>
                  <th style='text-align: center;width:150px'>操作</th>
                </tr> 
              </thead>
              <tbody>
                <!-- <tr>
                  <td style='text-align: center;'>贤心</td>
                  <td style="width:550px;text-align: center;">国产水果</td>
                  <td>
                      <button class="layui-btn layui-btn-sm" > 
                        <i class="layui-icon">&#xe642;</i>
                      </button>
                      <button class="layui-btn layui-btn-sm">
                        <i class="layui-icon">&#xe640;</i>
                      </button>
                  </td>
                </tr>
                <tr>
                  <td style='text-align: center;'>许闲心</td>
                  <td style="width:550px;text-align: center;">海鲜水产</td>
                  <td>
                      <button class="layui-btn layui-btn-sm">
                        <i class="layui-icon">&#xe642;</i>
                      </button>
                      <button class="layui-btn layui-btn-sm">
                        <i class="layui-icon">&#xe640;</i>
                      </button>
                  </td>
                </tr> -->
              </tbody>
            </table>
            
       </div>
  </div>
 
    <!-- 内容主体区域结束 -->
    <div class="layui-footer" style='background: #009688;color:#fff;height: 20px;line-height: 20px;font-size: 12px;'>
      <!-- 底部固定区域 -->
      © YiGuo.com - 易果生鲜 - 商品分类
    </div>
  </div>
            

 <!-- 遮罩 -->

 <div class='categoryShade editCategory' >
    <div class="categoryTop">
      <p>编辑分类</p>
      <div class="categoryClose">
        x
      </div>
    </div>
    <div class="categoryBottom">
        <div class="categoryBox">
           <p class='listName'>分类名：<input type="text" name="" class="editTxt" id="" placeholder="输入分类名"></p>
           <button class="layui-btn AlertBtn" style='margin:20px 0 0 58px' id="editAlterBtn" >
               确认
             </button>
        </div>
     </div>
</div>

<!-- 遮罩 -->
  <!-- 增加商品分类 -->
<div class='userShade addCategory'>
    <div class="userTop">
      <p>增加商品分类</p>
      <div class="userClose categoryClose">
        x
      </div>
    </div>
    <div class="userBottom">
        <div class="userBox">
            <div class="layui-form-item">
                <label class="layui-form-label">分类名</label>
                <div class="layui-input-block">
                  <input type="text" name="title" required  lay-verify="required" placeholder="请输入分类名" autocomplete="off" class="layui-input" style='width:200px;' id="cateVal">
                </div>
              </div>
           <button class="layui-btn AlertBtn" style='margin:10px 0 0 108px' id= "addAlterBtn">
               确认
             </button>
        </div>
     </div>
</div>

<script>
  //JavaScript代码区域
  layui.use('element', function(){
    var element = layui.element;
    
  });

  //Demo
  layui.use('form', function(){
    var form = layui.form;
    
    //监听提交
    form.on('submit(formDemo)', function(data){
      layer.msg(JSON.stringify(data.field));
      return false;
    });
  //============================================================
    
});
//用户名渲染
// let users = localStorage.getItem('users');
// console.log(JSON.parse(users).name);
// let _name=JSON.parse(users).name;
// showUsername(_name);
// //用户退出
// outUsername(_name);


  // ======================================
 let layuiLayout = document.querySelector('.layui-layout');
  var categoryShade = document.querySelector('.categoryShade');
//========================================================
//出现增加商品类别弹窗，关闭弹窗
 $(function(){
    //点击增加商品类别，出来弹窗
    $('.addBtn').on('click',function(){
      $('.addCategory').css('display','block');
      layuiLayout.style.opacity = '0.8';
      categoryShade.style.opacity = '1';
      // $('.layuiLayout').css('opacity','0.8');//加不上属性

    });


    //点击弹窗的X,弹窗隐藏
    $('.categoryClose').on('click',function(){
      $('.addCategory').css('display','none');
      $('.editCategory').css('display','none');

      layuiLayout.style.opacity = '1';
      $('#cateVal').val('');
    });


     
    //===============================================
    //所有ajax的路由
    var url='/category/_findAll';
    //1.查询所有的商品分类，并渲染,findAll在public.js函数中
      
       findAll(show);
       
    //思路：2先查询商品分类是否存在，然后增加
    //点击确实,弹窗隐藏
       
       $('#addAlterBtn').on('click',function(){
           var val=$('#cateVal').val();
            $('.addCategory').css('display','none');
            layuiLayout.style.opacity = '1';
            if(val){
              var data={category:val};
              //先查询再增加,public.js函数的封装函数中
             findOne(val,add,data,show);
             // $('#cateVal').val('');
              $('#cateVal').val('');
           }
       });

       //渲染数据的结构
       function show(str){
          var res=str.map(function(item,idx){
          return `<tr data-id="${item._id}">
                    <td style='text-align: center;'>${idx+1}</td>
                    <td style="width:550px;text-align: center;">${item.category}</td>
                    <td>
                        <button class="layui-btn layui-btn-sm editBtn">
                          <i class="layui-icon">&#xe642;</i>
                        </button>
                        <button class="layui-btn layui-btn-sm delBtn">
                          <i class="layui-icon">&#xe640;</i>
                        </button>
                    </td>
                  </tr>`;
         }).join('');
         $('tbody').html(res);
         var currentEditId;
         //===========渲染后的操作==============
        //点击修改按键，弹出修改窗体
         $('.editBtn').on('click',function(){
            $('.categoryShade').css('display','block');
            layuiLayout.style.opacity = '0.8';
            //===========编辑功能======================
            var currentEditTxt=$(this).parent().prev().text();
            currentEditId=$(this).parent().parent().attr('data-id');
            // console.log(currentEditTxt);
            $('.editTxt').val(currentEditTxt);
        });
         //======编辑的ajax请求开始========
         $('#editAlterBtn').on('click',function(){
            var val= $('.editTxt').val();
            // console.log(currentEditId,val);
            if(val){
              //ajax请求：先查询，再修改
              var data={_id:currentEditId,category:val};
              //先查询再修改,public.js函数的封装函数中
              findOne(val,update,data,show);

             $('.editCategory').css('display','none');
            }else{
              alett('信息不能为空');
            }
         });
          //======编辑的ajax请求结束========
          //删除单条数据ajax请求
          $('.delBtn').on('click',function(){
            // console.log($(this))
            var currentTr=$(this).parent().parent();
            // console.log(currentTr);
            var currentId=currentTr.attr('data-id');
            //向后端传送的数据
            var data={_id:currentId};
            _delete(data,show);
            // 
          });
       }


//=====================ajax的封装===================
//1.查询所有的商品分类
//参数：show是要渲染页面的函数
//      url:查询所有数据的路由
function findAll(fn){
     $.ajax({
        type:'get',
        url:'/category/_findAll',
        data:{},
        async:true,
        success:function(str){
            fn(str);
        }
     });   
}


//2.查询单条数据,再执行相应的操作
//参数val:查询的值
//      fun:data是函数要传到后端的值，是一个对象
//      fun2:渲染数据结构的函数，在这里，所有渲染数据结构的函数名都是show
function findOne(val,fun,data,fun2){
    $.ajax({
        type:'get',
        url:'/category/_find',
        data:{
          category:val,
        },
        async:true,
        success:function(str){
          if(str=='1'){
            fun(data,fun2);
          }else{
            alert('商品分类名已存在');
          }
        }
    });
}


//3.增加数据（增加后渲染页面）
//参数：data:商品分类的值,是一个对象,格式data={name:xiao,age:18}
//      fun2:渲染数据结构的函数，在这里，所有渲染数据结构的函数名都是show
//      url:查询所有数据的路由
 function add(data,fun){

       //ajax请求
       $.ajax({
          type:'get',
          url:'/category/_add',
          data:data,
          async:true,
          success:function(str){
              // console.log(str);
              // var res=JSON.parse(str);
              if(str.n=='1'){
                //渲染页面
                findAll(fun);
              }else{
                alert('增加失败');
              }
          }
       });   
      
}


//修改数据
//参数：data:修改前和修改后的值的集合，是一个对象
//      fun:渲染数据结构的函数，在这里，所有渲染数据结构的函数名都是show
//      url1:更新路由
//      url2:查询所有数据的路由
function update(data,fun){
  $.ajax({
    type:'get',
    url:'/category/_update',
    data:data,
    async:true,
    success:function(str){
        // console.log(str);
        // 更新成功，重新渲染
        if(str.n==1){
          findAll(fun);
        }
    }
  });
}


//删除数据
//参数：data:修改前和修改后的值的集合，是一个对象
//      fun:渲染数据结构的函数，在这里，所有渲染数据结构的函数名都是show
//      url:查询所有数据的路由
function _delete(data,fun){
    $.ajax({
      type:'get',
      url:'/category/_delete',
      data:data,
      async:true,
      success:function(str){
          // console.log(str);
          // 删除数据
          if(str.n==1){
            // currentTr.remove();
            findAll(fun);

          }
      }
    });
}
  
 });
 //点击Logo跳转到首页
  index();

  // 通过cookie设置头部的用户名显示,如果不是登录状态，都跳转到登陆页面
login();    
</script>
</body>
</html>